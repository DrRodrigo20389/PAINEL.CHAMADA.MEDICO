<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema V18 - Sincroniza√ß√£o Total</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <style>
        :root {
            /* DESIGN DARK NEON */
            --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --muted: #64748b;
            --blue: #38bdf8; --purple: #c084fc; --orange: #fb923c; --green: #4ade80; --red: #f87171;
            --border: #334155;
        }
        
        body, html { margin: 0; padding: 0; height: 100vh; font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); overflow: hidden; }

        /* TELA DE ESCOLHA */
        #setup-area { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; z-index: 1000; position: relative; background: var(--bg); }
        .choice-btn { 
            width: 320px; padding: 25px; margin: 15px; font-size: 1.2rem; cursor: pointer; border-radius: 12px; 
            border: 2px solid var(--blue); font-weight: bold; background: transparent; color: var(--blue);
            transition: 0.3s; box-shadow: 0 0 15px rgba(56, 189, 248, 0.1);
        }
        .choice-btn:hover { background: var(--blue); color: #0f172a; box-shadow: 0 0 30px rgba(56, 189, 248, 0.5); }

        /* LAYOUT M√âDICO */
        #doctor-area { display: grid; grid-template-rows: auto 1fr; height: 100vh; padding: 15px; gap: 15px; box-sizing: border-box; }

        .header-bar { display: flex; justify-content: space-between; align-items: center; }
        .location-select { background: var(--card); color: var(--green); border: 1px solid var(--border); padding: 10px; border-radius: 8px; font-weight: bold; font-size: 1rem; }

        .dashboard-grid { display: grid; grid-template-columns: 380px 1fr 350px; gap: 15px; height: 100%; overflow: hidden; }

        .panel { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; display: flex; flex-direction: column; overflow-y: auto; }

        /* TIMER & STATUS */
        .timer-box { background: rgba(0,0,0,0.3); border: 2px solid var(--border); border-radius: 10px; padding: 20px; text-align: center; margin-bottom: 20px; transition: 0.3s; }
        .timer-val { font-size: 5rem; font-weight: 800; line-height: 1; font-variant-numeric: tabular-nums; }
        .timer-lbl { font-size: 1rem; color: var(--muted); text-transform: uppercase; letter-spacing: 3px; }
        
        .mode-idle { border-color: var(--border); }
        .mode-exam { border-color: var(--blue); color: var(--blue); background: radial-gradient(circle, rgba(56,189,248,0.1) 0%, transparent 70%); }
        .mode-laudo { border-color: var(--purple); color: var(--purple); background: radial-gradient(circle, rgba(192,132,252,0.1) 0%, transparent 70%); }
        .mode-wait { border-color: var(--orange); color: var(--orange); background: radial-gradient(circle, rgba(251,146,60,0.1) 0%, transparent 70%); }

        .input-group { margin-bottom: 15px; }
        input[type="text"], select { width: 100%; background: #0f172a; border: 1px solid var(--border); color: white; padding: 12px; border-radius: 8px; box-sizing: border-box; margin-bottom: 8px; font-size: 1rem; outline: none; }
        input:focus { border-color: var(--blue); }

        .btn-action { width: 100%; padding: 18px; border: none; border-radius: 8px; font-weight: 800; cursor: pointer; font-size: 1.1rem; margin-bottom: 10px; text-transform: uppercase; transition: 0.2s; color: #0f172a; }
        .btn-action:hover { filter: brightness(1.1); }
        
        .btn-call { background: transparent; border: 2px solid var(--green); color: var(--green); }
        .btn-call:hover { background: rgba(74, 222, 128, 0.1); color: var(--green); }
        .btn-blue { background: var(--blue); } .btn-purple { background: var(--purple); } .btn-orange { background: var(--orange); } .btn-green { background: var(--green); }

        .call-log { text-align: center; color: var(--green); font-size: 0.9rem; padding: 10px; border: 1px dashed var(--border); border-radius: 6px; margin-bottom: 15px; min-height: 20px;}

        /* TABELA E DADOS */
        .stats-bar { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-box { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; text-align: center; }
        .stat-val { font-size: 1.4rem; font-weight: bold; }
        .stat-lbl { font-size: 0.75rem; color: var(--muted); text-transform: uppercase; }

        .table-container { flex: 1; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
        th { position: sticky; top: 0; background: var(--card); color: var(--muted); padding: 12px; text-align: left; border-bottom: 2px solid var(--border); }
        td { padding: 10px 12px; border-bottom: 1px solid #334155; }

        /* CONTROLE TV */
        .tv-controls h4 { margin-top: 0; color: var(--muted); border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .slider { width: 100%; accent-color: var(--blue); }
        .input-link { font-size: 0.85rem; padding: 8px; color: var(--blue); }

        /* TELA TV */
        #tv-area { display: grid; grid-template-columns: 50% 50%; height: 100vh; width: 100vw; background: #000; }
        .tv-sidebar { background: var(--bg); border-left: 3px solid var(--blue); display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; box-shadow: -10px 0 30px rgba(0,0,0,0.5); }
        .tv-status { color: var(--blue); border: 1px solid var(--blue); padding: 8px 30px; border-radius: 50px; font-size: 1.5vw; text-transform: uppercase; letter-spacing: 4px; }
        .tv-name { font-size: 4vw; font-weight: 900; color: white; margin: 40px 0; line-height: 1.1; animation: pulse 2s infinite; }
        .tv-loc { margin-top: auto; color: var(--muted); font-size: 1.2vw; }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.02); opacity: 0.9; } }

        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .modal-content { background: var(--card); padding: 40px; border-radius: 15px; border: 1px solid var(--orange); text-align: center; width: 450px; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="setup-area">
        <h1 style="color:white; letter-spacing: 5px; margin-bottom: 40px;">SISTEMA V18 FINAL</h1>
        <button class="choice-btn" onclick="init('medico')">üíª DASHBOARD M√âDICO</button>
        <button class="choice-btn" style="border-color:var(--green); color:var(--green)" onclick="init('tv')">üì∫ TELA DA RECEP√á√ÉO</button>
    </div>

    <div id="doctor-area" class="hidden">
        <div class="header-bar">
            <h3 style="margin:0; color:var(--muted); text-transform: uppercase;">Painel de Controle</h3>
            <select id="localSelect" class="location-select" onchange="updateLocal()">
                <option>CEMIR LAP√ÉO</option>
                <option>CEMIR AM√âRICA DOURADA</option>
                <option>CEMIR CANARANA</option>
                <option>DILAB BARRA DO MENDES</option>
            </select>
        </div>

        <div class="dashboard-grid">
            <div class="panel">
                <div id="timerDisplay" class="timer-box mode-idle">
                    <div class="timer-lbl" id="statusLabel">AGUARDANDO</div>
                    <div class="timer-val" id="timer">00:00</div>
                </div>
                <div class="input-group">
                    <input type="text" id="pName" placeholder="Nome do Paciente..." autocomplete="off">
                    <select id="pExams">
                        <option value="1">1 Exame</option>
                        <option value="2">2 Exames</option>
                        <option value="3">3 Exames</option>
                        <option value="4">4 Exames</option>
                        <option value="5">5+ Exames</option>
                    </select>
                </div>

                <div id="ctrl-start">
                    <button onclick="tvChamada()" class="btn-action btn-call">üì¢ CHAMAR NA TV</button>
                    <div id="lastCallDisplay" class="call-log">...</div>
                    <button onclick="nextStep()" class="btn-action btn-blue">‚ñ∂ INICIAR ATENDIMENTO</button>
                </div>
                <button id="ctrl-proc" onclick="nextStep()" class="btn-action btn-purple hidden">‚èπ PACIENTE SAIU / LAUDAR</button>
                <button id="ctrl-end" onclick="nextStep()" class="btn-action btn-green hidden">‚úî FINALIZAR / SALA VAZIA</button>
                <div id="ctrl-wait" class="hidden">
                    <button onclick="tvChamada()" class="btn-action btn-call">üì¢ CHAMAR PR√ìXIMO</button>
                    <div id="lastCallDisplayWait" class="call-log">...</div>
                    <button onclick="nextStep()" class="btn-action btn-orange">‚åõ PACIENTE ENTROU</button>
                </div>
            </div>

            <div class="panel">
                <div class="stats-bar">
                    <div class="stat-box"><div class="stat-val" id="stExam" style="color:var(--blue)">0m</div><div class="stat-lbl">Exame</div></div>
                    <div class="stat-box"><div class="stat-val" id="stReport" style="color:var(--purple)">0m</div><div class="stat-lbl">Laudo</div></div>
                    <div class="stat-box"><div class="stat-val" id="stWait" style="color:var(--orange)">0m</div><div class="stat-lbl">Espera</div></div>
                </div>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Paciente</th><th>Qtd</th><th>Exame</th><th>Laudo</th><th>Espera</th></tr></thead>
                        <tbody id="logBody"></tbody>
                    </table>
                </div>
                <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <button onclick="downloadJSON()" style="flex:1; padding:12px; background:var(--card); border:1px solid var(--green); color:var(--green); border-radius:6px; cursor:pointer;">üíæ EXPORTAR</button>
                    <button onclick="clearAll()" style="padding:12px; background:var(--card); border:1px solid var(--red); color:var(--red); border-radius:6px; cursor:pointer;">üóë LIMPAR</button>
                </div>
            </div>

            <div class="panel tv-controls">
                <h4>CONTROLE TV</h4>
                <label>VOLUME TV: <span id="volDisp" style="color:white; font-weight:bold;">30</span>%</label>
                <input type="range" class="slider" id="volInp" min="0" max="100" value="30" oninput="setVol(this.value)">

                <div style="margin-top: 20px; border-top: 1px solid var(--border); padding-top: 10px;">
                    <label>LINK V√çDEO 1</label>
                    <input type="text" id="vid1" class="input-link" placeholder="Cole link completo...">
                    <label>LINK V√çDEO 2</label>
                    <input type="text" id="vid2" class="input-link" placeholder="Cole link completo...">
                    <label>LINK V√çDEO 3</label>
                    <input type="text" id="vid3" class="input-link" placeholder="Cole link completo...">

                    <button onclick="updatePlaylist()" class="btn-action btn-blue" style="margin-top:15px; font-size: 0.9rem; padding: 12px;">‚Üª SINCRONIZAR V√çDEOS</button>
                </div>
            </div>
        </div>
    </div>

    <div id="tv-area" class="hidden">
        <div style="position:relative; width:100%; height:100%;">
            <div id="player"></div>
            <button id="unlockBtn" onclick="unlockAudio()" style="position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); color:white; font-size:1.5rem; border:none; z-index:100; cursor:pointer;">üîä CLIQUE AQUI PARA INICIAR üîä</button>
        </div>
        <div class="tv-sidebar">
            <div class="tv-status">CHAMADA</div>
            <div class="tv-name" id="tvName">...</div>
            <div class="tv-status" style="border-color:var(--purple); color:var(--purple); font-size:1.2vw; margin-top:30px;">SALA DE ULTRASSONOGRAFIA</div>
            <div class="tv-loc" id="tvLoc"></div>
        </div>
    </div>

    <div id="modalWait" class="modal">
        <div class="modal-content">
            <h2 style="color:var(--orange);">FIM DO INTERVALO</h2>
            <p style="color:var(--muted);">Tempo Parado:</p>
            <div style="font-size: 3rem; font-weight: bold; color: white; margin-bottom: 30px;" id="modalTime">00:00</div>
            <button class="btn-action btn-orange" onclick="endWait('recepcao')">üè¢ DEMORA RECEP√á√ÉO</button>
            <button class="btn-action" style="background:transparent; border:1px solid var(--muted); color:white; margin-top: 10px;" onclick="endWait('pausa')">‚òï MINHA PAUSA</button>
        </div>
    </div>

<script>
    // FIREBASE
    const firebaseConfig = { databaseURL: "https://painelclinica-default-rtdb.firebaseio.com/" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // VARIAVEIS
    let mode, player, timerInt, startTime, waitDuration;
    let state = 0; 
    let curRec = {};
    let records = JSON.parse(localStorage.getItem('recsV18')) || [];
    let curLoc = localStorage.getItem('locV18') || 'CEMIR LAP√ÉO';

    // REGEX BLINDADO
    function extractVideoID(url) {
        if(!url) return false;
        var regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
        var match = url.match(regExp);
        return (match && match[7].length == 11) ? match[7] : false;
    }

    function init(m) {
        mode = m;
        document.getElementById('setup-area').classList.add('hidden');
        
        if (m === 'medico') {
            document.getElementById('doctor-area').classList.remove('hidden');
            document.getElementById('localSelect').value = curLoc;
            render();
            
            // CARREGAR CONFIGS DO FIREBASE PARA A TELA DO MEDICO (Mem√≥ria)
            db.ref('config/volume').on('value', s => { 
                const v = s.val()||30; 
                document.getElementById('volInp').value = v; 
                document.getElementById('volDisp').innerText = v; 
            });
            
            db.ref('config/playlist').once('value', s => {
                const list = s.val();
                if(list) {
                    if(list[0]) document.getElementById('vid1').value = "https://youtube.com/watch?v=" + list[0];
                    if(list[1]) document.getElementById('vid2').value = "https://youtube.com/watch?v=" + list[1];
                    if(list[2]) document.getElementById('vid3').value = "https://youtube.com/watch?v=" + list[2];
                }
            });

        } else {
            document.getElementById('tv-area').classList.remove('hidden');
            var tag = document.createElement('script'); 
            tag.src = "https://www.youtube.com/iframe_api";
            document.body.appendChild(tag);
            
            // LISTENERS TV (SINCRONIA)
            db.ref('chamada').on('value', s => { 
                const d = s.val(); 
                if(d && (Date.now() - d.t < 60000)) announce(d.nome, d.loc); 
            });
            
            db.ref('config/volume').on('value', s => { if(player && player.setVolume) player.setVolume(s.val()); });
            
            // ATUALIZA√á√ÉO IMEDIATA DA PLAYLIST
            db.ref('config/playlist').on('value', s => { 
                const list = s.val();
                if(player && list && list.length > 0 && typeof player.loadPlaylist === 'function') {
                    console.log("Atualizando playlist na TV:", list);
                    player.loadPlaylist(list);
                    player.setLoop(true);
                }
            });
        }
    }

    // --- FUN√á√ïES DE SINCRONIA ---
    function updatePlaylist() {
        const v1 = document.getElementById('vid1').value;
        const v2 = document.getElementById('vid2').value;
        const v3 = document.getElementById('vid3').value;
        
        const id1 = extractVideoID(v1);
        const id2 = extractVideoID(v2);
        const id3 = extractVideoID(v3);

        const list = [id1, id2, id3].filter(id => id !== false);
        
        if(list.length > 0) {
            // SALVA NO MESMO CAMINHO QUE A TV ESCUTA (config/playlist)
            db.ref('config/playlist').set(list);
            alert("Sincronizado! A TV deve mudar em instantes.");
        } else {
            alert("Cole links v√°lidos do YouTube.");
        }
    }

    function tvChamada() {
        const n = document.getElementById('pName').value;
        if(!n) return alert("Digite o nome!");
        db.ref('chamada').set({ nome: n, loc: curLoc, t: Date.now() });
        const txt = `CHAMOU: ${n.toUpperCase()} (${new Date().toLocaleTimeString().slice(0,5)})`;
        document.getElementById('lastCallDisplay').innerText = txt;
        document.getElementById('lastCallDisplayWait').innerText = txt;
    }

    function setVol(v) { 
        db.ref('config/volume').set(parseInt(v)); 
        document.getElementById('volDisp').innerText = v; 
    }

    // --- PRODUTIVIDADE ---
    function updateLocal() { curLoc = document.getElementById('localSelect').value; localStorage.setItem('locV18', curLoc); render(); }
    
    function timerStart() {
        startTime = Date.now();
        clearInterval(timerInt);
        timerInt = setInterval(() => {
            const diff = Date.now() - startTime;
            const m = Math.floor(diff/60000).toString().padStart(2,'0');
            const s = Math.floor((diff%60000)/1000).toString().padStart(2,'0');
            document.getElementById('timer').innerText = `${m}:${s}`;
        }, 1000);
    }

    function nextStep() {
        const ui = {
            lbl: document.getElementById('statusLabel'),
            box: document.getElementById('timerDisplay'),
            btnStart: document.getElementById('ctrl-start'),
            btnProc: document.getElementById('ctrl-proc'),
            btnEnd: document.getElementById('ctrl-end'),
            btnWait: document.getElementById('ctrl-wait'),
            inp: document.getElementById('pName')
        };

        if(state === 0) { 
            if(!ui.inp.value && !confirm("Sem nome?")) return;
            state = 1; ui.inp.disabled = true;
            ui.lbl.innerText = "EM EXAME"; ui.box.className = "timer-box mode-exam";
            ui.btnStart.classList.add('hidden'); ui.btnProc.classList.remove('hidden');
            timerStart();
        } else if (state === 1) { 
            curRec.exam = Date.now() - startTime;
            state = 2;
            ui.lbl.innerText = "LAUDO"; ui.box.className = "timer-box mode-laudo";
            ui.btnProc.classList.add('hidden'); ui.btnEnd.classList.remove('hidden');
            timerStart();
        } else if (state === 2) { 
            curRec.report = Date.now() - startTime;
            curRec.name = ui.inp.value;
            curRec.qtd = parseInt(document.getElementById('pExams').value);
            curRec.loc = curLoc;
            state = 3;
            ui.lbl.innerText = "ESPERA"; ui.box.className = "timer-box mode-wait";
            ui.btnEnd.classList.add('hidden'); ui.btnWait.classList.remove('hidden');
            ui.inp.value = ''; ui.inp.disabled = false; ui.inp.focus();
            document.getElementById('pExams').value = '1';
            timerStart();
        } else if (state === 3) { 
            waitDuration = Date.now() - startTime;
            clearInterval(timerInt);
            const m = Math.floor(waitDuration/60000).toString().padStart(2,'0');
            const s = Math.floor((waitDuration%60000)/1000).toString().padStart(2,'0');
            document.getElementById('modalTime').innerText = `${m}:${s}`;
            document.getElementById('modalWait').style.display = 'flex';
        }
    }

    function endWait(type) {
        curRec.wait = waitDuration; curRec.wType = type;
        records.push(curRec); localStorage.setItem('recsV18', JSON.stringify(records));
        curRec = {}; state = 0;
        document.getElementById('modalWait').style.display = 'none';
        document.getElementById('ctrl-wait').classList.add('hidden');
        document.getElementById('ctrl-start').classList.remove('hidden');
        document.getElementById('statusLabel').innerText = "AGUARDANDO";
        document.getElementById('timerDisplay').className = "timer-box mode-idle";
        document.getElementById('timer').innerText = "00:00";
        document.getElementById('lastCallDisplay').innerText = "...";
        render();
    }

    function render() {
        const tbody = document.getElementById('logBody'); tbody.innerHTML = '';
        const fRecs = records.filter(r => r.loc === curLoc);
        [...fRecs].reverse().forEach(r => {
            tbody.innerHTML += `<tr>
                <td style="font-weight:bold; color:white;">${r.name}</td>
                <td style="text-align:center">${r.qtd}</td>
                <td style="color:var(--blue)">${fmt(r.exam)}</td>
                <td style="color:var(--purple)">${fmt(r.report)}</td>
                <td style="color:${r.wType=='recepcao'?'var(--orange)':'#555'}">${fmt(r.wait)}</td>
            </tr>`;
        });
        let te=0, tr=0, tw=0, cw=0, tq=0;
        fRecs.forEach(r => { te+=r.exam; tr+=r.report; tq+=r.qtd; if(r.wType=='recepcao'){ tw+=r.wait; cw++; }});
        document.getElementById('stExam').innerText = tq ? Math.round(te/tq/60000)+"m" : "0m";
        document.getElementById('stReport').innerText = tq ? Math.round(tr/tq/60000)+"m" : "0m";
        document.getElementById('stWait').innerText = cw ? Math.round(tw/cw/60000)+"m" : "0m";
    }

    function fmt(ms) { return Math.floor(ms/60000)+':'+Math.floor((ms%60000)/1000).toString().padStart(2,'0'); }
    function clearAll() { if(confirm("Limpar?")) { records = []; localStorage.setItem('recsV18', '[]'); render(); }}
    function downloadJSON() { 
        const a = document.createElement('a');
        a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(records));
        a.download = "data.json"; a.click();
    }

    // --- YOUTUBE API ---
    function onYouTubeIframeAPIReady() {
        db.ref('config/playlist').once('value').then(s => {
            const list = s.val();
            const firstVid = (list && list.length>0) ? list[0] : 'lO4yN8W4A5g';
            player = new YT.Player('player', {
                height: '100%', width: '100%', videoId: firstVid,
                playerVars: { 'autoplay': 1, 'controls': 0, 'mute': 1 },
                events: { 
                    'onReady': (e)=>{ 
                        e.target.setVolume(30); 
                        if(list) e.target.loadPlaylist(list);
                    },
                    'onStateChange': (e)=>{ if(e.data===0) e.target.playVideo(); }
                }
            });
        });
    }

    function unlockAudio() {
        document.getElementById('unlockBtn').style.display='none';
        if(player) { player.unMute(); player.setVolume(30); player.playVideo(); }
        window.speechSynthesis.speak(new SpeechSynthesisUtterance("Sistema Ativo"));
    }

    function announce(nome, loc) {
        document.getElementById('tvName').innerText = nome;
        document.getElementById('tvLoc').innerText = loc;
        if(player) player.setVolume(5);
        const msg = new SpeechSynthesisUtterance(`Paciente ${nome}. Sala de Ultrassonografia.`);
        msg.lang = 'pt-BR'; msg.rate = 0.9;
        msg.onend = () => { setTimeout(() => { if(player) player.setVolume(30); }, 1000); };
        window.speechSynthesis.speak(msg);
    }
</script>
</body>
</html>
