<script>
    const firebaseConfig = { databaseURL: "https://painelclinica-default-rtdb.firebaseio.com/" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let player, totalAcumulado = 0, volumeOriginal = 30;

    function init(m) {
        document.getElementById('setup-area').classList.add('hidden');
        if (m === 'medico') {
            document.getElementById('doctor-area').classList.remove('hidden');
            db.ref('financeiro/total').on('value', s => { totalAcumulado = s.val() || 0; atualizarDisplayTotal(); });
            db.ref('config/links_raw').once('value', s => {
                const l = s.val(); if(l) { 
                    document.getElementById('vid1').value = l.v1||''; 
                    document.getElementById('vid2').value = l.v2||''; 
                    document.getElementById('vid3').value = l.v3||''; 
                }
            });
        } else if (m === 'tablet') {
            document.getElementById('tablet-area').classList.remove('hidden');
            ouvirCobrancas();
        } else if (m === 'tv') {
            document.getElementById('tv-area').classList.remove('hidden');
            initTV();
        }
    }

    // EXTRAÇÃO AUTOMÁTICA
    function autoExtrairValor() {
        const codigo = document.getElementById('pixCode').value;
        const match = codigo.match(/54\d{2}(\d+\.\d{2})/);
        if (match && match[1]) document.getElementById('pixValue').value = match[1];
    }

    // MÉDICO
    function enviarParaTablet() {
        const valor = document.getElementById('pixValue').value || "Manual";
        const codigo = document.getElementById('pixCode').value;
        if(!codigo) return alert("Erro: Cole o código!");
        db.ref('cobranca').set({ valor, codigo, status: 'pendente', t: Date.now() });
    }

    function confirmarRecebimento() {
        const valor = parseFloat(document.getElementById('pixValue').value);
        if(isNaN(valor)) return alert("Digite o valor para somar.");
        db.ref('cobranca/status').set('pago');
        totalAcumulado += valor;
        db.ref('financeiro/total').set(totalAcumulado);
        document.getElementById('financeLog').innerHTML = `<div>R$ ${valor.toFixed(2)} - ${new Date().toLocaleTimeString()}</div>` + document.getElementById('financeLog').innerHTML;
        document.getElementById('pixValue').value = ''; document.getElementById('pixCode').value = '';
    }

    function zerarCaixa() { if(confirm("Zerar caixa?")) db.ref('financeiro/total').set(0); }
    function atualizarDisplayTotal() { document.getElementById('totalDia').innerText = `Total: R$ ${totalAcumulado.toFixed(2).replace('.',',')}`; }
    
    function tvChamada() { 
        const n = document.getElementById('pName').value;
        if(n) db.ref('chamada').set({ nome: n.toUpperCase(), t: Date.now() });
        document.getElementById('pName').value = ''; 
    }

    function updatePlaylist() {
        const extract = (url) => {
            var m = url.match(/^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/);
            return (m && m[7].length == 11) ? m[7] : false;
        };
        const v1 = document.getElementById('vid1').value, v2 = document.getElementById('vid2').value, v3 = document.getElementById('vid3').value;
        const ids = [extract(v1), extract(v2), extract(v3)].filter(i => i !== false);
        db.ref('config/links_raw').set({v1, v2, v3});
        db.ref('config/playlist').set(ids);
        alert("Playlist Sincronizada!");
    }

    // TABLET - GERAÇÃO DO QR CODE CORRIGIDA
    function ouvirCobrancas() {
        db.ref('cobranca').on('value', s => {
            const d = s.val(); if(!d) return;
            if(d.status === 'pendente') {
                document.getElementById('idle-msg').classList.add('hidden');
                document.getElementById('success-msg').classList.add('hidden');
                document.getElementById('pay-msg').classList.remove('hidden');
                document.getElementById('tabValue').innerText = `R$ ${d.valor.toString().replace('.',',')}`;
                
                const container = document.getElementById('qrcode-container');
                container.innerHTML = ''; // Limpa o "branco"
                
                // Pequeno delay para garantir que o contêiner está limpo antes de gerar
                setTimeout(() => {
                    new QRCode(container, {
                        text: d.codigo,
                        width: 320,
                        height: 320,
                        colorDark : "#000000",
                        colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.M // Nível de erro médio para códigos longos
                    });
                }, 100);

            } else if (d.status === 'pago') {
                document.getElementById('pay-msg').classList.add('hidden');
                document.getElementById('success-msg').classList.remove('hidden');
                setTimeout(() => { 
                    document.getElementById('success-msg').classList.add('hidden'); 
                    document.getElementById('idle-msg').classList.remove('hidden'); 
                }, 4000);
            }
        });
    }

    // TV
    function initTV() {
        var tag = document.createElement('script'); tag.src = "https://www.youtube.com/iframe_api";
        document.body.appendChild(tag);
        db.ref('config/volume').on('value', s => { volumeOriginal = s.val()||30; if(player) player.setVolume(volumeOriginal); });
        db.ref('config/playlist').on('value', s => { if(player && s.val()) { player.loadPlaylist(s.val()); player.setLoop(true); } });
        db.ref('chamada').on('value', s => {
            const d = s.val();
            if(d && (Date.now() - d.t < 10000)) {
                document.getElementById('tvName').innerText = d.nome;
                if(player) player.setVolume(5);
                const ut = new SpeechSynthesisUtterance(`Paciente ${d.nome}, Sala de ultrassonografia. Por gentileza, paciente ${d.nome}, queira se dirigir à sala de ultrassonografia.`);
                ut.lang = 'pt-BR';
                ut.onend = () => { if(player) player.setVolume(volumeOriginal); };
                window.speechSynthesis.speak(ut);
            }
        });
    }

    function onYouTubeIframeAPIReady() {
        db.ref('config/playlist').once('value').then(s => {
            const list = s.val() || ['6mK8shfTegE'];
            player = new YT.Player('player', {
                height: '100%', width: '100%',
                playerVars: { 'autoplay': 1, 'controls': 0, 'mute': 1, 'playlist': list.join(',') },
                events: { 'onReady': (e) => { e.target.playVideo(); } }
            });
        });
    }

    function setVol(v) { db.ref('config/volume').set(parseInt(v)); }
    function unlockAudio() { 
        document.getElementById('unlockBtn').style.display='none'; 
        if(player) { player.unMute(); player.setVolume(volumeOriginal); player.playVideo(); } 
    }
    function updateLocal() { localStorage.setItem('locV21', document.getElementById('localSelect').value); }
</script>
